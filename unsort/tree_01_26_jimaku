Got you â€” you want a **textâ€‘tree style breakdown** of what this whole script does, section by section, in a clean hierarchical structure.  
Hereâ€™s a clear, readable **textree** that maps the logic and flow of the entire system.

---

# ðŸŒ³ **TEXTREE â€” Highâ€‘Level Structure of the Script**

```
ROOT: anilist + jimaku integration system
â”‚
â”œâ”€â”€ 1. Environment Detection
â”‚     â”œâ”€â”€ Detects if running in MPV or standalone CLI
â”‚     â”œâ”€â”€ Loads mpv.utils only when inside MPV
â”‚     â””â”€â”€ Sets different paths for logs, cache, config
â”‚
â”œâ”€â”€ 2. Configuration
â”‚     â”œâ”€â”€ File paths (logs, cache, API key)
â”‚     â”œâ”€â”€ Jimaku settings (auto-download, max subs)
â”‚     â”œâ”€â”€ AniList API URL
â”‚     â””â”€â”€ Episode cache table
â”‚
â”œâ”€â”€ 3. Logging System
â”‚     â”œâ”€â”€ Unified debug_log()
â”‚     â”‚     â”œâ”€â”€ Writes timestamped logs
â”‚     â”‚     â”œâ”€â”€ Chooses correct log file (parser vs mpv)
â”‚     â”‚     â””â”€â”€ Prints to terminal unless suppressed
â”‚
â”œâ”€â”€ 4. Jimaku API Key Handling
â”‚     â”œâ”€â”€ load_jimaku_api_key()
â”‚     â”‚     â”œâ”€â”€ Reads API key from file
â”‚     â”‚     â””â”€â”€ Logs errors if missing
â”‚
â”œâ”€â”€ 5. Subtitle Cache Directory
â”‚     â”œâ”€â”€ ensure_subtitle_cache()
â”‚     â”‚     â”œâ”€â”€ Creates directory (mpv subprocess or OS)
â”‚     â”‚     â””â”€â”€ Ensures no Windows popup
â”‚
â”œâ”€â”€ 6. Episode Number Math
â”‚     â”œâ”€â”€ calculate_jimaku_episode()
â”‚     â”‚     â”œâ”€â”€ Converts SxEy â†’ cumulative episode
â”‚     â”‚     â””â”€â”€ Uses AniList season data or fallback 13 eps
â”‚     â”œâ”€â”€ convert_jimaku_to_anilist_episode()
â”‚     â”‚     â””â”€â”€ Reverse: cumulative â†’ season episode
â”‚
â”œâ”€â”€ 7. Jimaku Filename Parser
â”‚     â”œâ”€â”€ normalize_digits()
â”‚     â”œâ”€â”€ parse_jimaku_filename()
â”‚     â”‚     â”œâ”€â”€ Large pattern cascade:
â”‚     â”‚     â”‚     â”œâ”€â”€ SxxExx
â”‚     â”‚     â”‚     â”œâ”€â”€ EPxx / Exx
â”‚     â”‚     â”‚     â”œâ”€â”€ Episode xx
â”‚     â”‚     â”‚     â”œâ”€â”€ Japanese patterns (#, ç¬¬xxè©±, etc.)
â”‚     â”‚     â”‚     â”œâ”€â”€ Underscore patterns
â”‚     â”‚     â”‚     â”œâ”€â”€ Dash patterns
â”‚     â”‚     â”‚     â””â”€â”€ Pure numeric fallback
â”‚     â”‚     â””â”€â”€ Returns (season, episode)
â”‚
â”œâ”€â”€ 8. Torrent Filename Parser (for AniList matching)
â”‚     â”œâ”€â”€ extract_hash()
â”‚     â”œâ”€â”€ extract_quality()
â”‚     â”œâ”€â”€ normalize_title()
â”‚     â”œâ”€â”€ maybe_reverse() (fix reversed filenames)
â”‚     â”œâ”€â”€ clean_episode()
â”‚     â”œâ”€â”€ is_special()
â”‚     â””â”€â”€ parse_filename()
â”‚           â”œâ”€â”€ Detects:
â”‚           â”‚     â”œâ”€â”€ SxxExx
â”‚           â”‚     â”œâ”€â”€ Sx - Ex
â”‚           â”‚     â”œâ”€â”€ Season packs
â”‚           â”‚     â”œâ”€â”€ Episode xx
â”‚           â”‚     â”œâ”€â”€ Title - 01
â”‚           â”‚     â”œâ”€â”€ Underscore patterns
â”‚           â”‚     â”œâ”€â”€ Movie-year patterns
â”‚           â”‚     â””â”€â”€ Fallback title extraction
â”‚           â””â”€â”€ Normalizes title + season + episode
â”‚
â”œâ”€â”€ 9. Standalone Parser Test Mode
â”‚     â”œâ”€â”€ test_parser()
â”‚     â”‚     â”œâ”€â”€ Reads torrent list
â”‚     â”‚     â”œâ”€â”€ Runs parse_filename() on each
â”‚     â”‚     â””â”€â”€ Logs summary
â”‚     â””â”€â”€ CLI argument handling
â”‚
â”œâ”€â”€ 10. MPV Mode â€” Jimaku Integration
â”‚     â”œâ”€â”€ search_jimaku_subtitles()
â”‚     â”‚     â”œâ”€â”€ Queries Jimaku by AniList ID
â”‚     â”‚     â””â”€â”€ Returns entry metadata
â”‚
â”‚     â”œâ”€â”€ fetch_all_episode_files()
â”‚     â”‚     â”œâ”€â”€ GET /entries/<id>/files
â”‚     â”‚     â”œâ”€â”€ Caches results for 5 minutes
â”‚     â”‚     â””â”€â”€ Returns list of subtitle files
â”‚
â”‚     â”œâ”€â”€ match_episodes_intelligent()
â”‚     â”‚     â”œâ”€â”€ Parses every Jimaku filename
â”‚     â”‚     â”œâ”€â”€ Computes target cumulative episode
â”‚     â”‚     â”œâ”€â”€ Tries multiple matching strategies:
â”‚     â”‚     â”‚     â”œâ”€â”€ Direct SxxExx match
â”‚     â”‚     â”‚     â”œâ”€â”€ Netflix-style absolute numbering
â”‚     â”‚     â”‚     â”œâ”€â”€ Season-relative cumulative
â”‚     â”‚     â”‚     â”œâ”€â”€ Pure cumulative match
â”‚     â”‚     â”‚     â”œâ”€â”€ Direct episode match
â”‚     â”‚     â”‚     â””â”€â”€ Reverse cumulative conversion
â”‚     â”‚     â””â”€â”€ Returns list of matching files
â”‚
â”‚     â””â”€â”€ download_subtitle_smart()
â”‚           â”œâ”€â”€ Fetches all files
â”‚           â”œâ”€â”€ Matches intelligently
â”‚           â”œâ”€â”€ Downloads up to N matches
â”‚           â””â”€â”€ Loads them into MPV
â”‚
â””â”€â”€ END
```
add support for https://github.com/manami-project/anime-offline-database offline database for episode count lookup and other infos wow wish was aware of this earlier
add kitsunekko-mirro support offline/online support https://github.com/Ajatt-Tools/kitsunekko-mirror/

---

# ðŸŒŸ **What this system *actually accomplishes*** (plain English)

- It reads the filename of the video you're watching.  
- It parses the title, season, and episode using a huge pattern cascade.  
- It queries AniList to identify the anime.  
- It queries Jimaku.cc to find all subtitles for that anime.  
- It parses *every* Jimaku subtitle filename to extract episode numbers.  
- It converts between:
  - season episodes  
  - cumulative episodes  
  - Netflix-style numbering  
  - weird fansub numbering  
- It intelligently matches the correct subtitle file for the current episode.  
- It downloads the subtitle(s) into a cache folder.  
- It loads them into MPV automatically.  
- It logs everything for debugging.  

---

If you want, I can also generate:

- a **flowchart**,  
- a **sequence diagram**,  
- a **state machine**,  
- or a **developerâ€‘friendly README** for the repo.

Just tell me the format you prefer.