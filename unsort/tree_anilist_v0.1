AniList Integration Script (mpv + standalone)
│
├── 1. Environment Detection
│     ├── Detects if running in mpv or standalone Lua
│     ├── Sets CONFIG_DIR, LOG_FILE, PARSER_LOG_FILE, TEST_FILE accordingly
│     └── Loads mp.utils only in mpv mode
│
├── 2. Logging System
│     ├── debug_log(message, is_error)
│     │     ├── Writes timestamped logs to file
│     │     ├── Chooses parser log in standalone mode
│     │     └── Prints to terminal unless LOG_ONLY_ERRORS=true
│
├── 3. Filename Parser
│     ├── Helper functions:
│     │     ├── extract_hash()
│     │     ├── extract_quality()
│     │     ├── normalize_title()
│     │     ├── is_reversed() / maybe_reverse()
│     │     ├── clean_episode()
│     │     └── is_special()
│     │
│     ├── parse_filename(filename)
│     │     ├── Reverse string if needed
│     │     ├── Strip extension
│     │     ├── Extract release group [Group]
│     │     ├── Try multiple parsing patterns:
│     │     │     ├── S##E##
│     │     │     ├── S# - Episode (SubsPlease style)
│     │     │     ├── Season pack (no episode)
│     │     │     ├── "Episode ##"
│     │     │     ├── Title - Episode
│     │     │     ├── Underscore variants
│     │     │     ├── Movie-style (Title 2014)
│     │     │     └── Fallbacks
│     │     ├── Normalize title
│     │     ├── Extract season from title if missing
│     │     ├── Remove parenthetical junk
│     │     ├── Remove arc/part names (Zenpen, Kouhen, etc.)
│     │     └── Return structured result:
│     │           {title, season, episode, quality, is_special, group}
│
├── 4. Standalone Parser Mode
│     ├── Triggered via: lua anilist.lua --parser file.txt
│     ├── Reads torrent filenames from file
│     ├── Runs parse_filename() on each
│     ├── Logs successes/failures
│     └── Writes summary to parser-debug.log
│
├── 5. mpv Mode (AniList Integration)
│     ├── make_anilist_request(query, variables)
│     │     ├── Builds GraphQL request
│     │     ├── Executes curl via mpv subprocess
│     │     └── Parses JSON response
│     │
│     ├── search_anilist()
│     │     ├── Parse current filename
│     │     ├── Query AniList for matching anime
│     │     ├── Smart selection logic:
│     │     │     ├── Priority 1: SPECIAL/OVA match
│     │     │     ├── Priority 2: Match season number (S2/S3)
│     │     │     ├── Priority 3: Cumulative episode mapping
│     │     │     └── Fallback: first result
│     │     ├── Log all candidates
│     │     └── Show OSD message with:
│     │           ├── Selected title
│     │           ├── AniList ID
│     │           ├── Season + Episode
│     │           └── Format + total episodes
│     │
│     └── Keybind:
│           Press "A" → run search_anilist()
│
└── 6. Initialization
      └── Writes "AniList Script Initialized" to log
